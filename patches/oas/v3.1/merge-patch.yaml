---
$schema: https://spec.openapis.org/compliance/schemas/dialect/2023-06/oas-ontology
$id: https://spec.openapis.org/compliance/schemas/oas/3.1/2023-06
oasType: OpenAPI
oasChildren:
  0/info: 0#
  0/externalDocs: 0#
  0/servers: 0#
  0/security: securityRequirements
  0/tags: 0#
  0/paths: 0#
  0/webhooks: 0#
  0/components: 0#
oasLiterals:
  0/openapi: oasVersion
  0/jsonSchemaDialect: 0#
oasExtensible: true
properties:
  # Use the more strict version of the base dialect that this package
  # (oascomply) creates by patching the schemas.  This makes the extension
  # vocabulary mandatory, and enables the format-assertion vocabulary.
  jsonSchemaDialect:
    default: "https://spec.openapis.org/oas/3.1/dialect/strict"
  tags:
    oasTypeGroup: Tags
    oasChildren:
      0/{index}: tag
  servers:
    oasTypeGroup: Servers
    oasChildren:
      0/{index}: server
  securty:
    oasTypeGroup: SecurityRequirements
    oasChildren:
      0/{index}: securityRequirement

$defs:
  runtime-expression:
    oasType: RuntimeExpression
    type: string
    pattern: \$(url$|method$|statusCode$|request\.|response\.)

  specification-extensions:
    oasExtensible: true

  # Unless noted, the non-ref $defs is only referenced through these
  callbacks-or-reference:
    oasType: Callback
    oasReferences:
      0/$ref: Callback
  example-or-reference:
    oasType: Example
    oasReferences:
      0/$ref: Example
  header-or-reference:
    oasType: Header
    oasReferences:
      0/$ref: Header
  link-or-reference:
    oasType: Link
    oasReferences:
      0/$ref: Link
  parameter-or-reference:
    oasType: Parameter
    oasReferences:
      0/$ref: Parameter
  path-item-or-reference:
    # #/$defs/path-time is *not* always referenced through this schema
    oasType: PathItem
    oasReferences:
      0/$ref: PathItem
  request-body-or-reference:
    oasType: RequestBody
    oasReferences:
      0/$ref: RequestBody
  response-or-reference:
    oasType: Response
    oasReferences:
      0/$ref: Response
  security-scheme-or-reference:
    oasType: SecurityScheme
    oasReferences:
      0/$ref: SecurityScheme


  # TODO: Callbacks not well-understood
  callbacks:
    oasChildren:
      0/{name}/{pathTemplate}: callback

  components:
    oasType: Components
    oasExtensible: true
    oasChildren:
        0/{type}: componentGroup
    properties:
      callbacks:
        oasType: CallbackComponents
        oasChildren:
            0/{name}: namedCallback
      examples:
        oasType: ExampleComponents
        oasChildren:
            0/{name}: namedExample
      headers:
        oasType: HeaderComponents
        oasChildren:
            0/{name}: namedHeader
      links:
        oasType: LinkComponents
        oasChildren:
            0/{name}: namedLink
      pathItems:
        oasType: PathItemComponents
        oasChildren:
            0/{name}: namedPathItem
      parameters:
        oasType: ParameterComponents
        oasChildren:
            0/{name}: namedParameter
      requestBodies:
        oasType: RequestBodyComponents
        oasChildren:
            0/{name}: namedRequestBody
      responses:
        oasType: ResponseComponents
        oasChildren:
            0/{name}: namedResponse
      schemas:
        oasType: SchemaComponents
        oasChildren:
            0/{name}: namedSchema
        type: null  # Allow boolean schemas
        additionalProperties:
            $dynamicRef: null
            $ref: "#/$defs/schema"
      securitySchemes:
        oasType: SecuritySchemeComponents
        oasChildren:
            0/{name}: namedSecurityScheme

  contact:
    oasType: Contact
    oasLiterals:
      0/name: 0#
      0/url: 0#
      0/email: 0#

  content:
    oasTypeGroup: MediaTypes

  encoding:
    oasType: Encoding
    oasChildren:
      0/headers/{header}: header
    oasLiterals:
      0/contentType: 0#
      0/style: 0#
      0/explode: 0#
      0/allowReserved: 0#

  example:
    oasType: Example
    oasLiterals:
      0/summary: 0#
      0/description: 0#
      0/value: 0#
    oasDescriptionLinks:
      0/externalValue: 0#
    properties:
      description:
        format: commonmark

  external-documentation:
    oasType: ExternalDocumentation
    oasLiterals:
      0/description: 0#
    oasDescriptionLinks:
      0/url: 0#
    properties:
      description:
        format: commonmark

  header:
    oasType: Header
    oasChildren:
      0/schema: 0#
      0/content/{contentType}: 1#
    oasLiterals:
      0/description: 0#
      0/required: 0#
      0/deprecated: 0#
      0/style: 0#
      0/explode: 0#
    oasExamples:
      examples:
        - 0/example
        - 0/examples/{name}/value
      schemas:
        - 0/schema
        - 0/content/{contentType}/schema
    properties:
      description:
        format: commonmark
      schema:
        $dynamicRef: null
        $ref: "#/$defs/schema"

  info:
    oasType: Info
    oasChildren:
      0/contact: 0#
      0/license: 0#
    oasLiterals:
      0/title: 0#
      0/summary: 0#
      0/description: 0#
      0/version: apiDescriptionVersion
    oasDescriptionLinks:
      0/termsOfService: 0#
    oasExtensible: true
    properties:
      description:
        format: commonmark

  license:
    oasType: License
    oasLiterals:
      0/name: 0#
      0/identifier: 0#
    oasDescriptionLinks:
      0/url: 0#

  link:
    oasType: Link
    oasImplicitReferences:
      0/operationId:
        oasRelationType: operationIdRef
        oasTargetType: Operation
        oasTargetField: 0/operationId
      0/parameters/{name}#:
        # TODO: How much of this is really worth describing?
        #       oasTargetQualifier is essentially a one-off for
        #       this field, plus there is the constraint that
        #       the parameter referenced is connected to the
        #       Operation referenced by operationId or operationRef
        #       which is not being captured here.
        oasTargetType: Parameter
        oasTargetField: 0/name
        oasTargetQualifier: 0/in
    oasReferences:
        0/operationRef: Operation
    oasChildren:
      # TODO: Is this set up with an oasType anywhere?
      0/parameters/{parameterSpecification}: parameterSpecification

  media-type:
    oasType: MediaType
    oasChildren:
      0/schema: 0#
      0/encoding/{property}: 1#
    oasExamples:
      examples:
        - 0/example
        - 0/examples/{name}
      schemas:
        - 0/schema
      encodings:
        - 0/encoding/{property}
    properties:
      schema:
        $dynamicRef: null
        $ref: "#/$defs/schema"

  oauth-flows:
    oasType: OAuthFlows
    oasChildren:
      0/implicit: oauthFlowImplicit
      0/password: oauthFlowPassword
      0/clientCredentials: oauthFlowClientCredentials
      0/authorizationCode: oauthFlowAuthorizationCode
    $defs:
      implicit:
        oasType: ImplicitOAuthFlow
        oasLiterals:
          0/scopes/{scopeName}: scope
        oasApiLinks:
          0/authorizationUrl: 0#
          0/refreshUrl: 0#
      password:
        oasType: PasswordOAuthFlow
        oasLiterals:
          0/scopes/{scopeName}: scope
        oasApiLinks:
          0/tokenUrl: 0#
          0/refreshUrl: 0#
      client-credentials:
        oasType: ClientCredentialsFlow
        oasLiterals:
          0/scopes/{scopeName}: scope
        oasApiLinks:
          0/tokenUrl: 0#
          0/refreshUrl: 0#
      authorization-code:
        oasType: AuthorizationCodeOAuthFlow
        oasLiterals:
          0/scopes/{scopeName}: scope
        oasApiLinks:
          0/authorizationUrl: 0#
          0/tokenUrl: 0#
          0/refreshUrl: 0#

  operation:
    # for oasType, see /$defs/PathItem/properties/(get|put|...)
    oasChildren:
      0/externalDocs: 0#
      0/parameters: 0#
      0/requestBody: 0#
      0/responses: 0#
      0/callbacks: 0#
      0/security: securityRequirements
      0/servers: 0#
      0/tags: 0#
    oasLiterals:
      0/summary: 0#
      0/description: 0#
      0/operationId: 0#
      0/deprecated: 0#
    oasUniqueKey:
      fields:
        - 0/name
        - 0/in
      scope:
        - 0/parameters/{index}
        - 2/parameters/{index}
    properties:
      description:
        format: commonmark
      parameters:
        oasType: Parameters
        oasChildren:
          0/{index}: parameter
      security:
        oasTypeGroup: SecurityRequirements
        oasChildren:
          0/{index}: securityRequirement
      servers:
        oasTypeGroup: Servers
        oasChildren:
          0/{index}: server
      tags:
        oasTypeGroup: Tags
        oasImplicitReferences:
          0/{index}:
            oasRelationType: tagRef
            oasTargetType: Tag
            oasTargetField: 0/name
            oasTargetRequired: False

  parameter:
    oasChildren:
      0/schema: 0#
      0/content/{contentType}: 1#
    oasLiterals:
      0/name: 0#
      0/in: parameterLocation
      0/description: 0#
      0/required: 0#
      0/deprecated: 0#
      0/allowEmptyValue: 0#
      0/style: 0#
      0/explode: 0#
      0/allowReserved: 0#
    oasExamples:
      examples:
        - 0/example
        - 0/examples/{name}
      schemas:
        - 0/schema
        - 0/content/{contentType}/schema
      encodings:
        - 0/content/{contentType}/encoding/{property}
    oasExtensible: true
    properties:
      description:
        format: commonmark
      schema:
        $dynamicRef: null
        $ref: "#/$defs/schema"
    $defs:
      styles-for-path:
        then:
          oasType: PathParameter
          properties:
          name:
            oasType: TemplateParameter
      styles-for-query:
        then:
          oasType: QueryParameter
      styles-for-header:
        then:
          oasType: HeaderParameter
      styles-for-cookie:
        then:
          oasType: CookieParameter

  path-item:
    oasType: PathItem
    oasChildren:
      0/parameters: 0#
      0/servers: 0#
    oasIntermediate:
      intermediateRelation: operations
      oasTypeGroup: Operations
      oasChildren:
        0/delete: operation
        0/get: operation
        0/head: operation
        0/options: operation
        0/patch: operation
        0/post: operation
        0/put: operation
        0/trace: operation
    oasReferences:
      0/$ref: PathItem
    oasReferenceConflict:
      0/$ref: undefined
    oasLiterals:
      0/summary: 0#
      0/description: 0#
    properties:
      description:
        format: commonmark
      parameters:
        oasType: Parameters
        oasChildren:
          0/{index}: parameter
        items:
          oasReferences:
            0/$ref: Parameter
      servers:
        oasTypeGroup: Servers
        oasChildren:
          0/{index}: server
      delete:
        oasType: DeleteOperation
      get:
        oasType: GetOperation
      head:
        oasType: HeadOperation
      options:
        oasType: OptionsOperation
      patch:
        oasType: PatchOperation
      post:
        oasType: PostOperation
      put:
        oasType: PutOperation
      trace:
        oasType: TraceOperation

  paths:
    oasType: Paths
    oasChildren:
      0/{pathTemplate}: pathItem
    propertyNames:
      if:
        pattern: ^/
      then:
        oasType: TemplatedUrl

  reference:
    oasType: Reference
    oasLiterals:
      0/summary: 0#
      0/description: 0#
    properties:
      description:
        format: commonmark

  request-body:
    oasType: RequestBody
    oasChildren:
      0/content/{contentType}: content
    oasLiterals:
      0/description: 0#
      0/required: 0#
    properties:
      description:
        format: commonmark

  response:
    oasType: Response
    oasChildren:
      0/headers/{header}: header
      0/content/{contentType}: 1#
      0/links/{linkRel}: link
    oasLiterals:
      0/description: 0#
    oasExtensible: true
    properties:
      description:
        format: commonmark

  responses:
    oasType: Responses
    oasChildren:
      0/{statusSpecification}: response

  schema:
    $dynamicAnchor: null

  security-requirement:
    oasType: SecurityRequirement
    oasImplicitReferences:
      0/{scheme}#:
        oasRelationType: securitySchemeRef
        oasTargetType: SecurityScheme
        oasTargetField: 0/scheme
      0/{scheme}/{index}:
        oasRelationType: securitySchemeScopeRef
        oasTargetType: SecurityScheme
        oasTargetField: 0/{scheme}/flows/{flow}/scopes/{scope}#

  server:
    oasType: Server
    oasChildren:
      0/variables/{name}: variable
      0/url: 0#
    oasLiterals:
      0/description: 0#
    oasExtensible: true
    properties:
      description:
        format: commonmark
      url:
        oasType: TemplatedUrl

  server-variable:
    oasType: ServerVariable
    oasImplicitReferences:
      '0#':
        oasRelationType: serverVariableRef
        oasTargetType: Server
        oasTargetField: 0/url
        oasTargetIsTemplateVariable: true
    oasLiterals:
      0/enum/{index}: 1#
      0/default: 0#
      0/description: 0#
    oasExtensible: true
    properties:
      description:
        format: commonmark

  tag:
    oasType: Tag
    oasChildren:
      0/externaDocs: 0#
    oasLiterals:
      0/name: 0#
      0/description: 0#
    properties:
      description:
        format: commonmark

  security-scheme:
    oasLiterals:
      0/type: 0#
      0/name: 0#
      0/scheme: 0#
      0/in: parameterLocation
      0/description: 0#
    properties:
      description:
        format: commonmark
    $defs:
      type-apikey:
        then:
          oasType: APIKeySecurityScheme
      type-http:
        # We do not track type-http-bearer separately, and this subschema annotates both
        then:
          oasType: HTTPSecurityScheme
      type-oauth2:
        then:
          oasType: OAuth2SecurityScheme
      type-oidc:
        then:
          oasType: OpenIdConnectSecurityScheme
